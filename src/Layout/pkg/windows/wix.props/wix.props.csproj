<!-- Copyright (c) .NET Foundation and contributors. All rights reserved. Licensed under the MIT license. See License.txt in the project root for full license information. -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>$(SdkTargetFramework)</TargetFramework>
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyBuildOutputToPublishDirectory>false</CopyBuildOutputToPublishDirectory>
    <SetBuildNumbersDependsOn>
      SetDirectoryWixTargets
    </SetBuildNumbersDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <DirectoryWixTargetsTemplate>Directory.Wix.targets.pp</DirectoryWixTargetsTemplate>
    <DirectoryWixTargetsPath>$(ArtifactsDir)$(DirectoryWixTargetsTemplate.Replace(.pp,''))</DirectoryWixTargetsPath>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.Build.Tasks.Installers" GeneratePathProperty="true"/>
  </ItemGroup>

  <Target Name="SetMsiVersion">
    <PropertyGroup>
      <!-- This number comes from arcade and combines the date based build number id and the revision (incremental number per day)
           Fallback to 0 when patch number is not set. This happens only during CI. -->
      <CombinedBuildNumberAndRevision>$([MSBuild]::ValueOrDefault('$(_PatchNumber)', '000000'))</CombinedBuildNumberAndRevision>

      <!-- This number comes from arcade and combines the date based build number id and the revision (incremental number per day) -->
      <SDKBundleVersion>$(FileVersion)</SDKBundleVersion>
    </PropertyGroup>

    <GenerateMsiVersion BuildNumber="$(CombinedBuildNumberAndRevision)"
                        Major="$(VersionMajor)"
                        Minor="$(VersionMinor)"
                        Patch="$(VersionFeature)">
      <Output TaskParameter="MsiVersion" PropertyName="MsiVersion" />
    </GenerateMsiVersion>
  </Target>

  <!-- Ensure we only generate the MSI/Bundle version properties once to avoid each .wixproj generating new values
       and having different results when a build rolls over to the next day. -->
  <Target Name="SetDirectoryWixTargets"
          Inputs="$(DirectoryWixTargetsTemplate)"
          Outputs="$(DirectoryWixTargetsPath)"
          DependsOnTargets="SetMsiVersion">
    
    <PropertyGroup>
      <DirectoryWixTargetsTextHeader>&lt;!-- DO NOT MODIFY! Auto-generated from $(MSBuildProjectFullPath) --&gt;</DirectoryWixTargetsTextHeader>
      <DirectoryWixTargetsText>$([System.IO.File]::ReadAllText($(DirectoryWixTargetsTemplate)))</DirectoryWixTargetsText>

      <DirectoryWixTargetsText>$(DirectoryWixTargetsText.Replace('{msiVersion}', $(MsiVersion)))</DirectoryWixTargetsText>
      <DirectoryWixTargetsText>$(DirectoryWixTargetsText.Replace('{bundleVersion}', $(SDKBundleVersion)))</DirectoryWixTargetsText>
    </PropertyGroup>

    <WriteLinesToFile File="$(DirectoryWixTargetsPath)"
                      Lines="$(DirectoryWixTargetsTextHeader);$(DirectoryWixTargetsText)"
                      Overwrite="true"
                      WriteOnlyWhenDifferent="true" />
  </Target>

  <Target Name="SetBuildNumbers"
          DependsOnTargets="$(SetBuildNumbersDependsOn)"
          BeforeTargets="AfterBuild" />
</Project>
