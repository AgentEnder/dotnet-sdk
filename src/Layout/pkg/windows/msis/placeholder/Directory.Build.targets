<Project>
  <Import Project="$([MSBuild]::GetPathOfFileAbove('Directory.Build.targets', '$(MSBuildThisFileDirectory)../'))" />

  <PropertyGroup>
    <DefineConstants>$(DefineConstants);ProductName=$(SdkPlatformBrandName) from Visual Studio</DefineConstants>
  </PropertyGroup>

  <Target Name="GenerateUpgradeCode" BeforeTargets="CoreCompile">
    <!-- Only use the file name when generating the GUID. Full paths may be inconsistent across different build environments. -->
    <GenerateGuidFromName Name="$([System.IO.Path]::GetFileName($(SdkPlaceholderMSIInstallerFile)))">
      <Output TaskParameter="GeneratedGuid" PropertyName="UpgradeCode" />
    </GenerateGuidFromName>

    <PropertyGroup>
      <DefineConstants>$(DefineConstants);UpgradeCode=$(UpgradeCode)</DefineConstants>
    </PropertyGroup>
  </Target>

  <!-- The WiX SDK sets TargetPath based on the OutputName and defaults to the project name. If the compiler detects an .wxl files, the culture
       values are included as a subdirectory in the final output. When the output filename depends on properties that are set during the build, the
       output has to be renamed after the build completes. -->
  <Target Name="RenameOutput" AfterTargets="Build">
    <ItemGroup>
      <TargetOutputsToRename Include="$(TargetPath)" RenamedTargetPath="$(SdkPlaceholderMSIInstallerFile)" />
      <TargetOutputsToRename Include="$(TargetPdbPath)" RenamedTargetPath="$(SdkPlaceholderMSIInstallerFile.Replace('.msi', '.wixpdb'))" />
    </ItemGroup>

    <Move SourceFiles="@(TargetOutputsToRename)" DestinationFiles="%(RenamedTargetPath)" />
  </Target>
</Project>
